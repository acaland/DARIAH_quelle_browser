<html>
	<head>
    <script src="./isomorphic/system/modules/ISC_Core.js"></script>
    <script src="./isomorphic/system/modules/ISC_Foundation.js"></script>
    <script src="./isomorphic/system/modules/ISC_Containers.js"></script>
    <script src="./isomorphic/system/modules/ISC_Grids.js"></script>
    <script src="./isomorphic/system/modules/ISC_Forms.js"></script>
    <script src="./isomorphic/system/modules/ISC_DataBinding.js"></script>
		<script SRC="./isomorphic/skins/Enterprise/load_skin.js"></script>
</head>
<body>
<script>

/*isc.Button.create({
	title:"Add Row",
	width: 200,
	click: addRow
});

function btnShow() {
	hiddenBtn.show();
}; */

RPCManager.allowCrossDomainCalls = true;
// Canvas.resizeControls(5);
Canvas.resizeFonts(3);


isc.DataSource.create({
	ID: "quelleDS",
	//total: 500,
	dataURL: "http://glibrary.ct.infn.it:3500/v2/repos/dariah/quelle",
	//preventHTTPCaching: false,

	requestProperties: {
		httpHeaders: {
			"content-type": "application/json",
		}
	},
	transformRequest: function(dsRequest) {
		// var params = {
    // 	start : dsRequest.startRow,
    //   end : dsRequest.endRow
    // };

		dsRequest.httpHeaders["Authorization"] = access_token;
		dsRequest.actionURL = this.dataURL + "?filter[limit]=" + dsRequest.dataPageSize + "&filter[skip]=" + dsRequest.startRow + "&include_count=true";
		console.log("dsRequest", dsRequest);
		console.log("criteria", dsRequest.resultSet.getCriteria());
		var criteria = dsRequest.resultSet.getCriteria();
		var where = "";
		if (criteria) {
			for (key in criteria) {
				where = where + "&filter[where][" + key + "][like]=%" + criteria[key] + "%";
			}
			dsRequest.actionURL = dsRequest.actionURL + where;
		}
		console.log(where);
		//return dsRequest.data;
	},
	transformResponse: function(dsResponse, dsRequest, data) {
		console.log();
		dsResponse.totalRows = data.total;
		dsResponse.data = data.data;
		this.fields = [{ name: 'id', type: 'integer', hidden: true },
	  { name: 'tmphash' },
	  { name: 'gesamtwerkId', type: 'integer' }];

		console.log('dsResponse', dsResponse);
	},

	dataFormat: "json",
	fields: [
        { name: 'id', type: 'integer', detail: true },
	    { name: 'tmphash', detail: true },
        { name: 'gesamtwerkId', type: 'integer', detail: true },
        { name: 'typId', type: 'integer', detail: true },
        { name: 'veroeffentlicht', type: 'integer', detail: true },
        { name: 'titel', autoFitWidth: true },
        { name: 'untertitel', autoFitWidth: true  },
        { name: 'bandtitel' },
        { name: 'baende', type: 'integer' },
        { name: 'band' },
        { name: 'reihentitel',  autoFitWidth: true  },
        { name: 'reihennummer' },
        { name: 'auflage' },
        { name: 'nachdruck', detail: true },
        { name: 'erscheinungsort', detail: true },
        { name: 'erscheinungsjahr', type: 'integer', detail: true },
        { name: 'erstauflage', detail: true },
        { name: 'erscheinungszeitvon', type: 'integer', detail: true },
        { name: 'erscheinungszeitbis', type: 'integer', detail: true },
        { name: 'verlag', detail: true },
        { name: 'isbn', detail: true },
        { name: 'seiten', type: 'integer', detail: true },
        { name: 'seitenvonbis', detail: true },
        { name: 'seitenstruktur', detail: true },
        { name: 'hyperlink', detail: true },
        { name: 'hyperlinkDatum', type: 'datetime', detail: true },
        { name: 'exzerpiert', type: 'integer', detail: true },
        { name: 'belegmaterial', type: 'integer', detail: true },
        { name: 'bezugszeitraum', detail: true },
        { name: 'autor' },
        { name: 'bearbeiter' },
        { name: 'herausgeber' },
        { name: 'herausgeberreihe' },
        { name: 'kurzzitat' },
        { name: 'kurzzitatSort' },
        { name: 'langzitat' },
        { name: 'verweiszitat', detail: true },
        { name: 'zitatseite', type: 'integer', detail: true },
        { name: 'zitatspalte', type: 'integer', detail: true },
        { name: 'zitatversion', type: 'integer', detail: true },
        { name: 'zitatohneseite', type: 'integer', detail: true },
        { name: 'zitatjahr', type: 'integer', detail: true },
        { name: 'zitatjahrgang', type: 'integer', detail: true },
        { name: 'zitatband', type: 'integer', detail: true },
        { name: 'klassifikation', detail: true },
        { name: 'originaldaten', detail: true },
        { name: 'freigabe', type: 'integer', detail: true },
        { name: 'checked', type: 'integer', detail: true },
        { name: 'wordleiste', type: 'integer', detail: true },
        { name: 'druck', type: 'integer', detail: true },
        { name: 'online', type: 'integer', detail: true },
        { name: 'publiziert', type: 'integer', detail: true },
        { name: 'anmerkung', detail: true },
        { name: 'zugeordnet', type: 'integer', detail: true }
	]
});

var access_token = null;

function login(_callback) {
	var data = JSON.stringify({ username: "dariahadmin", password: "d4r142016"});
 	isc.RPCManager.sendRequest({
		data: data,
		useSimpleHttp: true,
		contentType: "application/json",
		actionURL: "http://glibrary.ct.infn.it:3500/v2/users/login",
		callback: function (response, data) {
			if (response.status != 0) {
				console.log(response.data.response.data);
				response.errors = response.data.response.data;
				_callback({success: false});
				return;
			}
			access_token = JSON.parse(data).id;
			console.log("sessione:", JSON.parse(data).id);
			//quelleDS.requestProperties.httpHeaders["Authorization"] = access_token;
			//console.log(todolistDS.requestProperties.httpHeaders);
			if (_callback) {
				_callback({success: true});
			}
		}
	});
}


if (!access_token) {
	login(function(e) {
		if (e.success) {
			//populateQuelle();
			quelle.fetchData();
		}
	})
} else {
	//populateQuelle();
	quelle.fetchData();
}


/* Not needed anymore: we implemented a server side method that returns the number of rows that match a query
function populateQuelle() {

	RPCManager.sendRequest({
		actionURL: "http://glibrary.ct.infn.it:3500/v2/repos/dariah/quelle/_count",
		httpHeaders: {"Authorization": access_token},
		httpMethod: "GET",
		callback: function(res, data) {
			quelleDS.total = JSON.parse(data).total;
			quelle.fetchData();
			//console.log(JSON.parse(data).total);
		}
	});
} */



isc.ListGrid.create({
	ID: "quelle",
	//left: 10,
	//top: 50,
	// width: "100%",
    // height: "100%",
    
	dataSource: "quelleDS",
	autoFetchData: false,
	canEdit: false,
	dataPageSize: 50,
	showFilterEditor: true,
    autoDraw: false,
    showResizeBar: true,
    alternateRecordStyles: true,
    selectionType:"single",
	//headerContextMenu: true
	//filterOnKeypress: true,
	//allowFilterOperators: true
    recordClick: function() {
        var record = this.getSelectedRecord();
        detailView.setData(record); 
    }
});

isc.ListGrid.create({
   ID: "asset_list",
   autoDraw: false,
   height: "30%" 
});

isc.DetailViewer.create({
    ID:"detailView",
    autoDraw:false,
    dataSource:"quelleDS",
    width:"30%",
    margin:"5",
    showDetailFields: true,
    canPickFields: true,
    showEmptyField: false,
    margin: 10,
    emptyMessage:"Select an item to view its details"
});

isc.VLayout.create({
    ID: "mainView",
    autoDraw: false,
    showResizeBar: true,
    members: [quelle, asset_list] 
});


isc.HLayout.create({
    ID:"pageLayout",
    width:"100%",
    height:"100%",
    autoDraw: true,
    layoutMargin: 10,
    members: [mainView, detailView]
});







</script>
</BODY></HTML>